---
title: "NBA"
author: "SEZYUEN_YIN"
date: "2018年12月19日"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# NBA dataset from kaggle

The data-set contains aggregate individual statistics for 67 NBA seasons. from basic box-score attributes such as points, assists, rebounds etc., to more advanced money-ball like features such as Value Over Replacement.

## import packages

Import essential packages for data manipulation.

```{r library}
library(dplyr)
library(ggplot2)
library(readr)
library(naniar)
```

## import the data set

The original data set is well collected and saved as a csv file. So it is easy to import the data set.

```{r import, echo=FALSE}
org_data <- read_csv("C:\\Users\\SEZYUEN\\Desktop\\kaggle\\Seasons_Stats.csv")
glimpse(org_data)
```

There are 53 variables and 24691 obvs in the data set. However, some meanless variables occur and we will deal with it later.
More importantly, some of the variables were not recorded at the early time of NBA, such as 3P%. (There is no 3 points line at that time!). We must keep that in mind 

```{r}
colnames(org_data)
```

```{r dropping some variables}
# Drop meanless variables
drop_cols <- c("X1", "blanl", "blank2")
org_data <- org_data %>% select(-one_of(drop_cols))
```

## Getting feel of missing data

```{r }
org_data <- as.data.frame(org_data)
miss_var_sum <- miss_var_summary(org_data)
miss_var_sum
```

The variables associate with 3 pts are missed heavily. It is because 3 pts had not brought into NBA until 1980. The same thing happend to TOV, ORB, DRB, STL and BLK.Considering those stat importance, we create subsets only including those possessing it.

Before create subsets, some variables must convert to numeric type.

```{r }
cols_to_conv <- c("3PAr", "ORB%", "DRB%", "TRB%", "AST%", "STL%", "BLK%", "TOV%", "USG%", "OBPM", "DBPM", "BPM", "VORP", "3P", "3PA", "3P%", "ORB", "DRB", "STL",
                  "BLK", "TOV")
org_data[, cols_to_conv] <- sapply(org_data[, cols_to_conv], as.numeric)

colnames(org_data)[which(names(org_data) == "3PAr")] <- "ThreePAr"
colnames(org_data)[which(names(org_data) == "3P")] <- "ThreeP"
colnames(org_data)[which(names(org_data) == "3PA")] <- "ThreePA"
colnames(org_data)[which(names(org_data) == "3P%")] <- "ThreeP%"
colnames(org_data)[which(names(org_data) == "2P")] <- "TwoP"
colnames(org_data)[which(names(org_data) == "2PA")] <- "TwoPA"
colnames(org_data)[which(names(org_data) == "2P%")] <- "TwoP%"

Three_data <- filter(org_data, !is.na(ThreeP))
miss_var_sum_for3 <- miss_var_summary(Three_data)
head(miss_var_sum_for3, n=20)
```

可以看到，还有3511个观察的3P%显示为missing，这个是由于这些观察的3分球出手与命中数都为0所导致的（分母为0），因此，将这种情况下的NA全部替换为数值0

```{r}
Three_data %>% filter(ThreeP == 0 & ThreePA == 0) %>% count() # Exactly 3511 obs
Three_data$`ThreeP%` <- replace(Three_data$`ThreeP%`, is.na(Three_data$`ThreeP%`), 0)
miss_var_summary(Three_data)
```

另外，当FGA等于0时，TwoP%, ThreePAr, FG%, eFG%, TS%都应该等于0

```{r}
filter(Three_data, is.na(Three_data$`FG%`) & FGA !=0)
Three_data$ThreePAr <- replace(Three_data$ThreePAr, is.na(Three_data$ThreePAr), 0)
miss_var_sum_for3 <- miss_var_summary(Three_data)
```

所有3分球出手相关的数据已经准备好了。

```{r}
Three_data %>% group_by(Year) %>% summarise(mean_3PA = mean(ThreePA)) %>% ggplot(aes(x = Year, y = mean_3PA)) + geom_point() + geom_smooth() + theme_classic()
```

从图中可以看出，自1980年引入3分球以来，3分球的出手数量逐年递增（除了1999年及2012年受到NBA停摆的影响以外）。而这其中又有一些特别的年份需要注意，如1995~1997和2016~2017年。

在此之前，先让我们看看过去30多年里球员的3分球命中率是怎么的？由于有许多球员并不出手3分球，所以他们的3分球命中率为0，为了剔除这部分球员的影响，这里采用中位数衡量每个赛季的3分球命中率情况。

```{r}
Three_data %>% group_by(Year) %>% summarise(`median_3P%` = median(`ThreeP%`)) %>% ggplot(aes(x = Year, y =`median_3P%`)) +geom_point() + geom_smooth() +theme_minimal()
```

可以看到，在3分球刚引入联盟的时候，3分球并不受人待见，甚至在80年代出现持续3分球命中率的中位数为0，也就是说起码有一半的球员从来就没有命中过3分球。与3分球出手数的情况类似，3分球命中率在95、96、97这3年出现异常的提高。在这几个年份中发生了什么？首先看看这几个年份中3分出手的球员。

```{r}
Three_data %>% filter(Year %in% c(1995, 1996, 1997)) %>% select(Year, Player, ThreePA, ThreeP, `ThreeP%`, ThreePAr) %>% group_by(Year) %>% arrange(Year, desc(ThreePA)) %>% filter(row_number() <= 10)
```

```{r}
Three_data %>% filter(Year %in% c(1993, 1994, 1998)) %>% select(Year, Player, ThreePA, ThreeP, `ThreeP%`, ThreePAr) %>% group_by(Year) %>% arrange(Year, desc(ThreePA)) %>% filter(row_number() <= 10)
```

三分狂人的出现。在1995~1997三个赛季中，分别涌现出多位3分狂人，他们单季的3分球出手数超过了600次，而在往前和往后的93、94及98的赛季中都没有这样的三分出手狂人。其中在1995年John Starcks出手611次三分球，1996年George McCloud出手678次三分球，还有Dennis Scott和Mookie Blaylock分别出手628次及623次，1997年Mookie Blaylock出手604次三分球。而且在这3个赛季中，3分球出手数前10的球员总体也多于相邻的几个赛季。

```{r}
# Most 3PTA players during 1993 ~ 1999
Three_data %>% filter(Year %in% c(1993,1994,1995,1996,1997,1998)) %>% select(Year, Player, ThreePA, ThreeP, `ThreeP%`, ThreePAr) %>% group_by(Year) %>% arrange(Year, desc(ThreePA)) %>% filter(row_number() <= 10) %>% ggplot(aes(x = Year, y = ThreePA)) + geom_point() + theme_classic()
```

但是，这几个赛季中的3分狂人大多都难以持续表现，连续3年出现在95~97的3分出手前10榜单的球员仅有1人，为Mookie Blaylock

```{r}
Three_95_top10 <- Three_data %>% filter(Year == 1995) %>% select(Year, Player, ThreePA, ThreeP, `ThreeP%`, ThreePAr) %>% group_by(Year) %>% arrange(Year, desc(ThreePA)) %>% filter(row_number() <= 10)

Three_96_top10 <- Three_data %>% filter(Year == 1996) %>% select(Year, Player, ThreePA, ThreeP, `ThreeP%`, ThreePAr) %>% group_by(Year) %>% arrange(Year, desc(ThreePA)) %>% filter(row_number() <= 10)

Three_97_top10 <- Three_data %>% filter(Year == 1997) %>% select(Year, Player, ThreePA, ThreeP, `ThreeP%`, ThreePAr) %>% group_by(Year) %>% arrange(Year, desc(ThreePA)) %>% filter(row_number() <= 10)

Three_95_top10 %>% inner_join(Three_96_top10, by = 'Player') %>% inner_join(Three_97_top10, by = 'Player')
```

那么，在2016和2017年的故事又是怎样的呢？

```{r}
Three_data %>% filter(Year %in% c(2015,2016,2017)) %>% select(Year, Player, ThreePA, ThreeP, `ThreeP%`, ThreePAr) %>% group_by(Year) %>% arrange(Year, desc(ThreePA)) %>% filter(row_number() <= 10)
```

在2016和2017的两个赛季中，库里连续两年霸占三分球出手次数第1（其实从2013年开始就是他），这与之前95~97赛季的3分狂人情况大大不同。
那么，库里究竟在3分球上为什么是历史级别

# Stephen Curry

在这份数据中，与3分球相关的主要数据有ThreePA（出手数），ThreeP（命中数），ThreeP%（命中率），ThreePAr（出手率）。先前我们已经大致看到了NBA历史三分球出手数的走势，但衡量一个优秀的三分手，命中数和命中率才是更有效的指标。那么库里的这两项指标在历史中是什么水平呢？

首先需要将三分球命中数为0的obs剔除，再在此基础上考察一下三分球命中数（ThreeP）的分布情况。

```{r}
Made_3_data <- Three_data %>% filter(ThreeP > 0)

Made_3_data %>% ggplot(aes(ThreeP)) + geom_bar()
```

可以看到ThreeP有明显的长尾，大部分obs单季的三分球命中数都在100一下。我们考察一下具体的分位数。

```{r}
quantile(Made_3_data$ThreeP)
```

可以看到，有50%的obs单季三分球命中数在17个及一下。单季三分球命中数在17个及以下很难被认为是一名3分球投手，因此我们把这部分obs也剔除在讨论之外。

```{r}
Made_3_data <- Made_3_data %>% filter(ThreeP > 17)

Made_3_data %>% ggplot(aes(ThreeP)) + geom_bar()
```

```{r}
print(quantile(Made_3_data$ThreeP))

ggplot(Made_3_data, aes(y=ThreeP)) + geom_boxplot()
```

此时三分球命中数的中位数为55，上分位数为91。
再来看看这些球员在三分球命中数和三分球命中率这两项数据上的分布情况。

```{r}
curry_summary <- Made_3_data %>% filter(Player == 'Stephen Curry') %>% select(ThreeP, `ThreeP%`)

Made_3_data %>% ggplot(aes(x = ThreeP, y = `ThreeP%`, color = ThreePAr)) + geom_point(shape = 1, alpha = 0.6) + geom_point(data = curry_summary, shape = 9, size = 3, color = 'red') +theme_minimal()
```

库里是NBA历史上唯一一位单季三分球命中数大于400的球员（甚至大于300也是唯一一位）。而他的三分球命中率也远高于平均水准。接下来我们就来看看球员三分球命中率的情况。

```{r}
Made_3_data %>% ggplot(aes(`ThreeP%`)) + geom_density(size=1) + geom_vline(xintercept = curry_summary$`ThreeP%`, color = 'yellow') + geom_vline(xintercept = quantile(Made_3_data$`ThreeP%`), color = 'red') + theme_minimal()

```

库里所有赛季的三分球命中率都高于40%，全部高于75%分位数。而在单季命中100球及以上3分的球员中，库里的表现依旧出色，三分球命中率同样全部超过75%分位数。

```{r}
Made_3_100_data <- Made_3_data %>% filter(ThreeP >= 100)

#Made_3_100_data %>% ggplot(aes(`ThreeP%`)) + geom_density() + geom_vline(xintercept = curry_summary$`ThreeP%`, color = 'yellow') + geom_vline(xintercept = quantile(Made_3_100_data$`ThreeP%`), color = 'red')

Made_3_100_data %>% select(Year, Player, `ThreeP%`, ThreeP) %>% arrange(desc(`ThreeP%`))
```

在2016年，库里以45.4%的单季三分球命中率（生涯最高，NBA历史第31位）投进402记三分球（NBA记录）

# 伟大的3分手

伟大的3分手首先就是要投进足够多的3分球，这里我对3分球命中数排在历史前300的球员进行汇总。第300名的是Robert Covington，命中了478记3分球。

```{r}
Top_300_3_pointer <- Three_data %>% select(Year, Player, `ThreeP%`, ThreeP, ThreePAr) %>% group_by(Player) %>% summarise(Total_3 = sum(ThreeP)) %>% arrange(desc(Total_3))  %>% filter(row_number() <= 300)

tail(Top_300_3_pointer)
```

将这份300人的名单和Three_data进行inner_join之后，就可以得到这300人在每个赛季的表现。接下来就让我们看看有什么有趣的。

```{r}
Top_300_3_pointer_seasonal <- inner_join(Three_data, Top_300_3_pointer, by = 'Player') %>% group_by(Year) %>% distinct(Player, .keep_all = TRUE) %>% ungroup()
```

首先看看这300人的首秀时间（这里指的是有3分球记录以来的时间即1980年，如拉里伯德虽然在1979年就登陆NBA，但是这份名单中任按照1980年的数据为初始。另外，由于这里的300人是根据职业生涯的总三分球命中数筛选出来的，所以近年出现在名单中的球员数量自然较少）。

可以看到，1999年有17位球员最终上榜了该300人名单，为历史最多（当然，这份名单很快就会被更新）。这17人中包含了文斯卡特、德克诺维斯基、保罗皮尔斯、佩贾斯托克亚维齐等大名鼎鼎的名字。

```{r}
Top_300_3_pointer_seasonal %>% distinct(Player, .keep_all = TRUE) %>% group_by(Year) %>% count()  %>% ggplot(aes(x = Year, y = n)) + geom_col()
```

```{r}
Top_300_3_pointer_seasonal %>% distinct(Player, .keep_all = TRUE) %>% group_by(Year) %>% count()

Top_300_3_pointer_seasonal %>% distinct(Player, .keep_all = TRUE) %>% group_by(Year) %>% filter(Year == 1999)
```

而在2012年，这份名单中的164人同时活跃在联盟，其中就包括历史三分王雷阿伦，也有斯提夫库里和克莱汤普森等未来的三分球霸主，当然也有如科比布兰恩特、卡梅隆安东尼、凯文杜兰特这样的历史级得分手。

```{r}
Top_300_3_pointer_seasonal%>% group_by(Year) %>% count()  %>% ggplot(aes(x = Year, y = n)) + geom_col()
```

```{r}
Top_300_3_pointer_seasonal %>% group_by(Year)%>% filter(Year == 2012)
```

## 王中之王

历史排名前300的三分手究竟谁最出色？

```{r}
Top_300_3_pointer_seasonal <- Top_300_3_pointer_seasonal %>% mutate(Year_Player = paste(Year, Player, sep = "_"))

#Top_300_3_pointer_seasonal %>% ggplot(aes(ThreeP)) + geom_density()

Cluster_Top_300_data <- Top_300_3_pointer_seasonal %>% filter(ThreeP > 15 & `ThreeP%` > 0.26 & ThreePAr > 0.11) %>% select(ThreePAr, ThreeP, ThreePA, `ThreeP%`)


```

```{r}

# Check if scaling is necessary
colMeans(Cluster_Top_300_data)

apply(Cluster_Top_300_data, 2, sd)

# Produce new matrix with columns of mean of 0 and sd of 1
scaled_Cluster_Top_300_data <- scale(Cluster_Top_300_data)

colMeans(scaled_Cluster_Top_300_data)

apply(scaled_Cluster_Top_300_data, 2, sd)

```

```{r}
# Hierarchical cluster

hclust_Top_300 <- hclust(dist(scaled_Cluster_Top_300_data), method = "complete")

cut_Top_300 <- cutree(hclust_Top_300, k = 5)

table(cut_Top_300)
```

```{r}
Cluster_result <- Top_300_3_pointer_seasonal %>% filter(ThreeP > 15 & `ThreeP%` > 0.26 & ThreePAr > 0.11) %>% bind_cols(as.data.frame(cut_Top_300)) %>% rename(clusters = cut_Top_300)

colnames(Cluster_result)

Cluster_result %>% ggplot(aes(x = ThreeP, y = `ThreeP%`, color = ThreePAr)) + geom_point() + facet_grid(.~clusters)
```

```{r}
Cluster_result %>% filter(Player == "Stephen Curry") %>% select(Year_Player, clusters) 

cluster4 <- Cluster_result %>% filter(clusters == 4) %>% select(Year_Player, Year, Player, ThreePAr, `ThreeP%`, ThreeP, ThreePA)
cluster3 <- Cluster_result %>% filter(clusters == 3) %>% select(Year_Player, Year, Player, ThreePAr, `ThreeP%`, ThreeP, ThreePA)
cluster2 <- Cluster_result %>% filter(clusters == 2) %>% select(Year_Player, Year, Player, ThreePAr, `ThreeP%`, ThreeP, ThreePA)
cluster1 <- Cluster_result %>% filter(clusters == 1) %>% select(Year_Player, Year, Player, ThreePAr, `ThreeP%`, ThreeP, ThreePA)
```

```{r}
Cluster_result %>% group_by(clusters)  %>% summarise(mean_ThreeP = mean(ThreeP), mean_ThreePA = mean(ThreePA), mean_ThreePercent = mean(`ThreeP%`), mean_ThreePAr = mean(ThreePAr))
```

```{r 典型代表}
cluster4 %>% group_by(Player) %>% count() %>% arrange(desc(n))
cluster3 %>% group_by(Player) %>% count() %>% arrange(desc(n))
cluster2 %>% group_by(Player) %>% count() %>% arrange(desc(n))
cluster1 %>% group_by(Player) %>% count() %>% arrange(desc(n))
```





